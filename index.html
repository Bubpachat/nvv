<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÉ‡∏à GoliveNew Year 2026 (Offline Mode) ü§´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Mali:wght@300;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      body { font-family: "Mali", cursive; }
      @keyframes popIn {
        0% { transform: scale(0.5) rotate(0deg); opacity: 0; }
        80% { transform: scale(1.1) rotate(5deg); opacity: 1; }
        100% { transform: scale(1) rotate(var(--rotation)); opacity: 1; }
      }
      .note-enter { animation: popIn 0.5s ease-out forwards; }
      @keyframes slideUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .slide-up { animation: slideUp 0.3s ease-out forwards; }
      .pin {
        position: absolute; top: -12px; left: 50%; transform: translateX(-50%) rotate(-15deg);
        width: 14px; height: 14px; background: radial-gradient(circle at 30% 30%, #f8abab, #fa1515);
        border-radius: 50%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25); z-index: 10;
      }
      .pin::before {
        content: ""; position: absolute; top: -4px; left: 2px; width: 10px; height: 6px;
        background: linear-gradient(#fde047, #f5490b); border-radius: 50%;
      }
      .pin::after {
        content: ""; position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
        width: 2px; height: 14px; background: linear-gradient(#e5e7eb, #9ca3af);
      }
    </style>
  </head>
  <body class="bg-gray-800 min-h-screen text-gray-800 relative overflow-x-hidden selection:bg-pink-300 selection:text-pink-900">
    
    <div class="fixed inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#ffffff 2px, transparent 2px); background-size: 30px 30px;"></div>

    <div id="networkStatus" class="fixed bottom-4 right-4 z-[60] hidden transition-all duration-300 transform translate-y-20">
      <div class="bg-gray-900 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 border border-white/20">
        <i id="statusIcon" class="ph-fill ph-wifi-slash text-red-400 animate-pulse"></i>
        <span id="statusText" class="text-sm font-bold">Offline Mode</span>
      </div>
    </div>

    <div id="loginScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900/95 backdrop-blur-sm transition-opacity duration-500">
      <h1 class="text-5xl font-bold text-white mb-8 drop-shadow-lg text-center leading-normal">
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô<br /><span class="text-2xl text-yellow-300 font-normal">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</span>
      </h1>
      <button onclick="signInWithGoogle()" class="bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition flex items-center gap-3 text-xl group">
        <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-8 h-8 group-hover:rotate-12 transition-transform" alt="Google Logo" />
        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
      </button>
      <p class="text-gray-400 mt-6 text-sm bg-black/20 px-4 py-2 rounded-lg">üîí ‡∏£‡∏∞‡∏ö‡∏ö Offline First: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞ Sync ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡πá‡∏ï</p>
    </div>

    <div id="appContent" class="hidden opacity-0 transition-opacity duration-500">
      <header class="text-center py-8 relative z-10">
        <div class="absolute top-2 right-4 flex items-center gap-2 bg-gray-900/50 p-2 pl-4 rounded-full backdrop-blur-sm border border-white/10 z-50 hover:bg-gray-900/80 transition-colors">
          <div class="text-right hidden md:block">
            <p id="userDisplayName" class="text-white font-bold text-sm leading-tight"></p>
            <p id="userEmailDisplay" class="text-gray-300 text-[10px] leading-tight"></p>
          </div>
          <img id="userAvatar" src="" class="w-8 h-8 rounded-full border border-white shadow-sm bg-gray-600" />
          <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full shadow transition flex items-center justify-center ml-1" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
            <i class="ph-bold ph-sign-out"></i>
          </button>
        </div>
        <h1 class="relative translate-y-14 text-4xl md:text-6xl font-bold text-white drop-shadow-lg transform -rotate-2 z-0">
          üì¢ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏µ 2025... 2026 ‡∏õ‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ö‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
        </h1>
      </header>

      <div class="max-w-xl mx-auto px-4 mb-10 relative z-10">
        <div class="bg-white/10 backdrop-blur-md p-6 rounded-2xl shadow-xl border border-white/20">
          <textarea id="messageInput" rows="3" class="w-full p-4 rounded-xl bg-white/90 focus:outline-none focus:ring-4 focus:ring-yellow-300 text-lg placeholder-gray-400 shadow-inner resize-none text-gray-800" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏ö‡∏≠‡∏Å..."></textarea>
          <div class="flex justify-between items-center mt-4">
            <div class="flex gap-2">
              <button onclick="selectColor('yellow')" class="w-8 h-8 rounded-full bg-yellow-300 ring-2 ring-white ring-offset-2 ring-offset-gray-800 hover:scale-110 transition color-btn shadow-md" data-color="yellow"></button>
              <button onclick="selectColor('pink')" class="w-8 h-8 rounded-full bg-pink-300 hover:scale-110 transition color-btn shadow-md" data-color="pink"></button>
              <button onclick="selectColor('blue')" class="w-8 h-8 rounded-full bg-sky-300 hover:scale-110 transition color-btn shadow-md" data-color="blue"></button>
              <button onclick="selectColor('green')" class="w-8 h-8 rounded-full bg-green-300 hover:scale-110 transition color-btn shadow-md" data-color="green"></button>
            </div>
            <button onclick="postConfession()" id="postBtn" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-2 px-6 rounded-full shadow-lg transform active:scale-95 transition flex items-center gap-2">
              <span>‡πÅ‡∏õ‡∏∞‡πÄ‡∏•‡∏¢!</span>
              <i class="ph-bold ph-paper-plane-tilt"></i>
            </button>
          </div>
        </div>
      </div>

      <main class="max-w-7xl mx-auto px-4 pb-20 relative z-0">
        <div id="wallContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 auto-rows-max">
          <div id="loading" class="col-span-full text-center text-white py-10 animate-pulse flex flex-col items-center gap-4">
            <i class="ph-duotone ph-spinner-gap text-4xl animate-spin"></i>
            <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÉ‡∏à...</span>
          </div>
        </div>
      </main>
    </div>

    <div class="fixed bottom-1 left-1/2 -translate-x-1/2 inline-block px-4 py-1 bg-white/5 backdrop-blur-sm rounded-full border border-white/10 shadow-lg">
      <p class="text-gray-400 text-[10px] md:text-sm tracking-widest text-center">
        ¬© <span class="text-yellow-400 font-bold">Copyright : 2025</span> @
        <span class="text-pink-400">Pirun Bubpachat &amp; Kru Waroonporn &amp; "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ï‡∏±‡∏Å‡∏®‡∏¥‡∏•‡∏≤"</span>
      </p>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, deleteDoc, updateDoc, doc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

      // === 1. SETUP FIREBASE ===
      const firebaseConfig = {
        apiKey: "AIzaSyBuOT1BPE09DTZvYsDFUzF_6SeZjzQtNzg",
        authDomain: "golivenewyear2026-c1afd.firebaseapp.com",
        projectId: "golivenewyear2026-c1afd",
        storageBucket: "golivenewyear2026-c1afd.firebasestorage.app",
        messagingSenderId: "329257002566",
        appId: "1:329257002566:web:b29762bcd5bef19d6c0c47",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const APP_ID = "Bubpachat";

      // Enable Offline
      const enableOffline = async () => {
        try { await enableIndexedDbPersistence(db); } catch (err) { console.warn("Offline persistence error:", err.code); }
      };
      enableOffline();

      // === 2. AUTHENTICATION ===
      const loginScreen = document.getElementById("loginScreen");
      const appContent = document.getElementById("appContent");
      let currentUser = null;

      window.signInWithGoogle = async () => {
        const provider = new GoogleAuthProvider();
        try { await signInWithPopup(auth, provider); } catch (error) { alert("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
      };

      window.logout = async () => {
        if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
          await signOut(auth);
          window.location.reload();
        }
      };

      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          loginScreen.classList.add("hidden");
          appContent.classList.remove("hidden");
          setTimeout(() => appContent.classList.remove("opacity-0"), 100);
          document.getElementById("userDisplayName").innerText = user.displayName;
          document.getElementById("userEmailDisplay").innerText = user.email;
          document.getElementById("userAvatar").src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}`;
          startApp();
        } else {
          currentUser = null;
          loginScreen.classList.remove("hidden");
        }
      });

      // === 3. NETWORK STATUS ===
      function updateNetworkStatus() {
        const status = document.getElementById("networkStatus");
        const icon = document.getElementById("statusIcon");
        const text = document.getElementById("statusText");
        status.classList.remove("hidden", "translate-y-20");
        status.classList.add("slide-up");

        if (navigator.onLine) {
          icon.className = "ph-fill ph-wifi-high text-green-400";
          text.innerText = "Online - Synced";
          setTimeout(() => status.classList.add("translate-y-20"), 3000);
        } else {
          icon.className = "ph-fill ph-wifi-slash text-red-400 animate-pulse";
          text.innerText = "Offline Mode - Saved to device";
        }
      }
      window.addEventListener("online", updateNetworkStatus);
      window.addEventListener("offline", updateNetworkStatus);

      // === 4. APP LOGIC ===
      let selectedColor = "yellow";
      const colorMap = {
        yellow: "bg-yellow-200 text-yellow-900 rotate-1 shadow-yellow-500/20",
        pink: "bg-pink-200 text-pink-900 -rotate-1 shadow-pink-500/20",
        blue: "bg-sky-200 text-sky-900 rotate-2 shadow-sky-500/20",
        green: "bg-green-200 text-green-900 -rotate-2 shadow-green-500/20",
      };

      function startApp() {
        const wallCollection = collection(db, "artifacts", APP_ID, "public", "data", "confessions");
        const q = query(wallCollection);
        const wallContainer = document.getElementById("wallContainer");
        const loading = document.getElementById("loading");

        onSnapshot(q, (snapshot) => {
          loading.style.display = "none";
          const notesData = [];
          snapshot.forEach((doc) => notesData.push({ id: doc.id, ...doc.data() }));
          
          notesData.sort((a, b) => {
            const t1 = a.timestamp ? a.timestamp.seconds : Date.now() / 1000;
            const t2 = b.timestamp ? b.timestamp.seconds : Date.now() / 1000;
            return t2 - t1;
          });

          renderNotes(notesData);
        });

        function renderNotes(notes) {
          wallContainer.innerHTML = "";
          if (notes.length === 0) {
            wallContainer.innerHTML = `<div class="col-span-full text-center text-white/50 py-10 flex flex-col items-center"><i class="ph-duotone ph-pencil-slash text-6xl mb-4 opacity-50"></i><span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏™‡∏¥!</span></div>`;
            return;
          }
          notes.forEach(createNoteElement);
        }

        function createNoteElement(data) {
          const noteId = data.id;
          const div = document.createElement("div");
          div.id = `note-${noteId}`;
          const colorClass = colorMap[data.color] || colorMap["yellow"];
          const rot = data.rotation || Math.random() * 6 - 3;
          
          div.className = `group p-6 rounded-lg shadow-md hover:shadow-2xl transition-all duration-300 note-enter relative min-h-[220px] flex flex-col justify-between ${colorClass}`;
          div.style.setProperty("--rotation", `${rot}deg`);

          // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
          const isOwner = currentUser && data.uid === currentUser.uid;
          const buttonsHtml = isOwner ? `
            <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-20">
                <button onclick="window.editConfession('${noteId}')" class="bg-white/70 hover:bg-white p-1 rounded-full text-sm w-7 h-7 flex items-center justify-center shadow-sm text-blue-600 transition-colors" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="ph-bold ph-pencil-simple"></i></button>
                <button onclick="window.deleteConfession('${noteId}')" class="bg-white/70 hover:bg-red-500 hover:text-white p-1 rounded-full text-sm w-7 h-7 flex items-center justify-center shadow-sm text-red-600 transition-colors" title="‡∏•‡∏ö"><i class="ph-bold ph-trash"></i></button>
            </div>
          ` : "";

          div.innerHTML = `
            <div class="pin"></div>
            ${buttonsHtml}
            <div class="mb-4 pt-2">
              <p class="note-text text-xl font-medium leading-relaxed break-words whitespace-pre-wrap">${data.text}</p>
            </div>
            <div class="mt-auto pt-3 border-t border-black/10">
              <div class="flex items-center gap-2 mb-2 opacity-80">
                <div class="w-8 h-8 rounded-full bg-black/10 flex items-center justify-center text-sm font-bold text-black/50 uppercase border border-white/30">
                  ${(data.authorName || "?").charAt(0)}
                </div>
                <div class="flex flex-col leading-none overflow-hidden">
                  <span class="text-sm font-bold truncate">${isOwner ? "‡∏Ñ‡∏∏‡∏ì (‡∏â‡∏±‡∏ô‡πÄ‡∏≠‡∏á)" : maskName(data.authorName)}</span>
                  <span class="text-[13px] opacity-70 truncate">${maskEmail(data.authorEmail)}</span>
                </div>
              </div>
            </div>
          `;
          wallContainer.appendChild(div);
        }

        // --- CRUD ---
        window.postConfession = async () => {
          const input = document.getElementById("messageInput");
          const text = input.value.trim();
          if (!text) return input.focus();

          const btn = document.getElementById("postBtn");
          btn.disabled = true;
          input.value = "";

          addDoc(wallCollection, {
            text, color: selectedColor, timestamp: serverTimestamp(),
            rotation: Math.random() * 6 - 3,
            uid: currentUser.uid, authorEmail: currentUser.email, authorName: currentUser.displayName
          }).finally(() => { btn.disabled = false; });
        };

        window.editConfession = async (id) => {
          const textEl = document.querySelector(`#note-${id} .note-text`);
          const newText = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:", textEl.innerText);
          if (newText && newText.trim() !== "") {
            const noteRef = doc(db, "artifacts", APP_ID, "public", "data", "confessions", id);
            updateDoc(noteRef, { text: newText.trim() }).catch(err => alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"));
          }
        };

        window.deleteConfession = async (id) => {
          if (confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏ô‡πâ‡∏ï‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) {
            const noteRef = doc(db, "artifacts", APP_ID, "public", "data", "confessions", id);
            deleteDoc(noteRef).catch(err => alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö"));
          }
        };
      }

      window.selectColor = (color) => {
        selectedColor = color;
        document.querySelectorAll(".color-btn").forEach(btn => {
          btn.classList.remove("ring-2", "ring-white", "ring-offset-2", "ring-offset-gray-800");
          if(btn.dataset.color === color) btn.classList.add("ring-2", "ring-white", "ring-offset-2", "ring-offset-gray-800");
        });
      };

      function maskName(name) { return name ? name.trim().charAt(0) + "XXX" : "‡∏ô‡∏¥‡∏£‡∏ô‡∏≤‡∏°"; }
      function maskEmail(email) {
        if (!email) return "";
        const [u, d] = email.split("@");
        return u.charAt(0) + "XXX@" + d;
      }
    </script>
  </body>
</html>
