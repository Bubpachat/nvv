<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Chat Room & Private üí¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: "Mali", cursive; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes messagePop {
            0% { transform: scale(0.9); opacity: 0; transform-origin: bottom left; }
            100% { transform: scale(1); opacity: 1; transform-origin: bottom left; }
        }
        .msg-anim { animation: messagePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes badgePop {
            0% { transform: scale(0); }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .badge-anim { animation: badgePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .bg-theme-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-theme-2 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); }
        .bg-theme-3 { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .bg-theme-4 { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        .bg-theme-5 { background-color: #1a202c; }

        /* Animation for Online Status */
        .online-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>

<body id="mainBody" class="bg-theme-1 h-[100dvh] w-full overflow-hidden text-gray-800 transition-colors duration-500">

    <!-- === 1. LOGIN SCREEN === -->
    <div id="loginScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-500">
        <div class="bg-white/90 p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full mx-4 border border-white/50">
            <div class="mb-4 text-6xl">üí¨</div>
            <h1 class="text-3xl font-bold mb-2 text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó</h1>
            <p class="text-gray-500 mb-8 text-sm">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ</p>
            <button id="btnLogin" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-3">
                <i class="fa-brands fa-google"></i> Google Login
            </button>
        </div>
    </div>

    <!-- === 2. MAIN APP LAYOUT === -->
    <div id="appScreen" class="hidden h-full max-w-6xl mx-auto bg-white/10 backdrop-blur-md shadow-2xl md:border-x border-white/10 relative overflow-hidden">
        
        <!-- Left Side: Chat Area -->
        <div class="flex-1 flex flex-col h-full relative z-10 transition-all duration-300" id="chatSection">
            <!-- Header -->
            <header class="flex-none p-4 flex items-center justify-between bg-white/20 backdrop-blur-lg border-b border-white/10 shadow-sm z-20">
                <div class="flex items-center gap-3">
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (Mobile) -->
                    <button onclick="toggleUserList()" class="relative md:hidden text-white bg-white/20 p-2 rounded-full w-10 h-10 hover:bg-white/30">
                        <i class="fa-solid fa-users"></i>
                        <div id="mobileTotalBadge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center shadow-sm border border-white">0</div>
                    </button>

                    <div class="relative">
                         <img id="currentChatAvatar" src="https://cdn-icons-png.flaticon.com/512/166/166258.png" class="w-10 h-10 rounded-full border-2 border-white shadow-sm bg-gray-200 object-cover">
                         <div id="onlineIndicator" class="hidden absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border border-white online-dot"></div>
                    </div>
                    <div>
                        <h2 id="chatTitle" class="font-bold text-white text-lg leading-tight shadow-black drop-shadow-md">‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° (Public)</h2>
                        <span id="chatSubtitle" class="text-[10px] text-white/80 bg-black/20 px-2 py-0.5 rounded-full">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <!-- Theme & Logout -->
                    <div class="hidden md:flex gap-1 bg-black/20 p-1 rounded-full backdrop-blur-sm">
                        <button onclick="changeTheme('bg-theme-1')" class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 border border-white/50"></button>
                        <button onclick="changeTheme('bg-theme-2')" class="w-6 h-6 rounded-full bg-gradient-to-br from-pink-300 to-pink-500 border border-white/50"></button>
                        <button onclick="changeTheme('bg-theme-3')" class="w-6 h-6 rounded-full bg-gradient-to-br from-green-300 to-blue-300 border border-white/50"></button>
                        <button onclick="changeTheme('bg-theme-5')" class="w-6 h-6 rounded-full bg-gray-800 border border-white/50"></button>
                    </div>
                    <button onclick="logout()" class="w-9 h-9 rounded-full bg-red-500/80 hover:bg-red-600 text-white flex items-center justify-center shadow">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                </div>
            </header>

            <!-- Chat Messages -->
            <main id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar scroll-smooth"></main>

            <!-- Input Area -->
            <footer class="flex-none p-3 bg-white/20 backdrop-blur-md border-t border-white/10">
                <form id="chatForm" class="flex gap-2 items-end">
                    <div class="flex-1 bg-white rounded-2xl shadow-inner relative">
                        <input type="text" id="msgInput" class="w-full p-3 pl-4 rounded-2xl bg-transparent focus:outline-none text-gray-800 placeholder-gray-400" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." autocomplete="off">
                    </div>
                    <button type="submit" class="w-12 h-12 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg transform active:scale-90 transition flex items-center justify-center">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </form>
            </footer>
        </div>

        <!-- Right Side: User List (Sidebar) -->
        <aside id="userListSection" class="absolute md:relative inset-y-0 right-0 w-72 bg-white/30 backdrop-blur-xl border-l border-white/20 transform translate-x-full md:translate-x-0 transition-transform duration-300 z-30 flex flex-col">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-white/10">
                <h3 class="font-bold text-white drop-shadow-md">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h3>
                <button onclick="toggleUserList()" class="md:hidden text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-2">
                <button onclick="switchChat(null)" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/40 transition mb-2 bg-white/20 border border-white/30 text-white text-left shadow-sm">
                    <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white text-lg font-bold border-2 border-white">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <div>
                        <div class="font-bold text-sm">‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° (Public)</div>
                        <div class="text-xs opacity-80">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å</div>
                    </div>
                </button>
            </div>

            <div id="usersContainer" class="flex-1 overflow-y-auto p-2 space-y-2 no-scrollbar">
                <!-- User items will be injected here -->
                <div class="text-center text-white/60 text-sm mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            
            <div class="p-3 border-t border-white/10 text-center">
                <div class="flex items-center gap-2 justify-center bg-black/20 rounded-full py-1 px-3 w-fit mx-auto">
                    <img id="myAvatarSmall" src="" class="w-6 h-6 rounded-full border border-white">
                    <span id="myNameSmall" class="text-xs text-white font-bold truncate max-w-[100px]"></span>
                </div>
            </div>
        </aside>

        <!-- Overlay for mobile when sidebar is open -->
        <div id="sidebarOverlay" onclick="toggleUserList()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, query, orderBy, serverTimestamp, limit, where } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
            apiKey: "AIzaSyAyhrB2VJ0WPYNmwBBYhHcuil1xOoLhI-M",
            authDomain: "golivenewyear2026.firebaseapp.com",
            projectId: "golivenewyear2026",
            storageBucket: "golivenewyear2026.firebasestorage.app",
            messagingSenderId: "777246005760",
            appId: "1:777246005760:web:b56000a2918a69079856e5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const APP_ID = typeof __app_id !== "undefined" ? __app_id : "default-app-id";
        
        let currentUser = null;
        let currentChatPartner = null; 
        let messageUnsubscribe = null;
        let unreadListenerUnsubscribe = null;
        
        // Track unread counts: { uid: count }
        let unreadCounts = {}; 
        let appStartTime = Date.now(); // To prevent counting old messages on reload

        // === UI ELEMENTS ===
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const chatContainer = document.getElementById('chatContainer');
        const chatForm = document.getElementById('chatForm');
        const msgInput = document.getElementById('msgInput');
        const usersContainer = document.getElementById('usersContainer');

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch (e) { console.error(e); }
            }
        };
        initAuth();

        // === AUTH STATE LISTENER ===
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                appScreen.classList.add('flex');
                
                document.getElementById('myAvatarSmall').src = user.photoURL || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                document.getElementById('myNameSmall').innerText = user.displayName || "Anonymous";

                // Load saved unread counts
                try {
                    const saved = localStorage.getItem(`unread_${currentUser.uid}`);
                    if(saved) unreadCounts = JSON.parse(saved);
                } catch(e) { unreadCounts = {}; }

                switchChat(null);
                updatePresence();
                setInterval(updatePresence, 60000); 
                listenToOnlineUsers();
                listenToConversations(); // Start listening for new messages globally

            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                appScreen.classList.remove('flex');
                if(messageUnsubscribe) messageUnsubscribe();
                if(unreadListenerUnsubscribe) unreadListenerUnsubscribe();
            }
        });

        async function updatePresence() {
            if(!currentUser) return;
            const userRef = doc(db, "artifacts", APP_ID, "public", "data", "users_online", currentUser.uid);
            try {
                await setDoc(userRef, {
                    uid: currentUser.uid,
                    displayName: currentUser.displayName || "Anonymous",
                    photoURL: currentUser.photoURL || "https://cdn-icons-png.flaticon.com/512/847/847969.png",
                    lastSeen: serverTimestamp()
                }, { merge: true });
            } catch (err) { console.error(err); }
        }

        document.getElementById('btnLogin').onclick = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
            catch (e) { alert(e.message); }
        };

        window.logout = () => signOut(auth);

        //NOTIFICATION
        function listenToConversations() {
            if(unreadListenerUnsubscribe) unreadListenerUnsubscribe();

            const q = query(
                collection(db, "artifacts", APP_ID, "public", "data", "latest_conversations"),
                where("users", "array-contains", currentUser.uid),
                limit(20)
            );

            unreadListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    
                    // ‡∏î‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    if (change.type === 'added' || change.type === 'modified') {
                        // Skip if I sent it
                        if (data.senderId === currentUser.uid) return;

                        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏±‡πä‡∏¢
                        const partnerId = data.users.find(uid => uid !== currentUser.uid);
                        if (!partnerId) return;

                        // Determine if we should increment count
                        // 1. Is this chat NOT currently open?
                        const isChatClosed = !currentChatPartner || currentChatPartner.uid !== partnerId;
                        
                        // 2. Is this message actually new? (Timestamp check)
                        // If it's an 'added' event from initial load, the timestamp might be old.
                        // We check if message timestamp is newer than when we loaded the app to avoid spam on refresh
                        // OR if it's a 'modified' event which usually implies a new write.
                        let msgTime = 0;
                        if (data.timestamp) msgTime = data.timestamp.toMillis ? data.timestamp.toMillis() : Date.now();
                        const isNewMessage = msgTime > appStartTime;

                        if (isChatClosed && isNewMessage) {
                            unreadCounts[partnerId] = (unreadCounts[partnerId] || 0) + 1;
                            updateBadgeUI(partnerId);
                            saveUnread();
                        }
                    }
                });
            });
        }

        function updateBadgeUI(uid) {
            const count = unreadCounts[uid] || 0;
            const badgeEl = document.getElementById(`badge-${uid}`);
            
            if (badgeEl) {
                if (count > 0) {
                    badgeEl.innerText = count > 99 ? '99+' : count;
                    badgeEl.classList.remove('hidden');
                    badgeEl.classList.add('badge-anim'); // Pop animation
                    // Remove anim class after play
                    setTimeout(() => badgeEl.classList.remove('badge-anim'), 300);
                } else {
                    badgeEl.classList.add('hidden');
                }
            }
            
            // Update Mobile Total Badge
            const total = Object.values(unreadCounts).reduce((a, b) => a + b, 0);
            const mobileBadge = document.getElementById('mobileTotalBadge');
            if(total > 0) {
                mobileBadge.innerText = total > 99 ? '99+' : total;
                mobileBadge.classList.remove('hidden');
            } else {
                mobileBadge.classList.add('hidden');
            }
        }

        function saveUnread() {
            localStorage.setItem(`unread_${currentUser.uid}`, JSON.stringify(unreadCounts));
        }

        // === USER LIST LOGIC ===
        function listenToOnlineUsers() {
            const usersRef = collection(db, "artifacts", APP_ID, "public", "data", "users_online");
            const q = query(usersRef, orderBy("lastSeen", "desc"), limit(50));

            onSnapshot(q, (snapshot) => {
                usersContainer.innerHTML = '';
                const now = Date.now();
                
                if(snapshot.empty) {
                    usersContainer.innerHTML = '<div class="text-white/50 text-center text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>';
                }

                let foundOthers = false;
                snapshot.forEach(docSnap => {
                    const u = docSnap.data();
                    if(u.uid === currentUser.uid) return;
                    foundOthers = true;

                    let isOnline = false;
                    if(u.lastSeen) {
                        const diff = now - (u.lastSeen.seconds * 1000);
                        isOnline = diff < 5 * 60 * 1000; 
                    }

                    const el = document.createElement('button');
                    // Add ID for badge targeting
                    el.id = `user-btn-${u.uid}`;
                    el.className = `relative w-full flex items-center gap-3 p-2 rounded-xl hover:bg-white/20 transition mb-1 text-left ${isOnline ? 'opacity-100' : 'opacity-70 grayscale-[0.5]'}`;
                    el.onclick = () => {
                        switchChat(u);
                        if(window.innerWidth < 768) toggleUserList();
                    };

                    const badgeCount = unreadCounts[u.uid] || 0;
                    const badgeHidden = badgeCount === 0 ? 'hidden' : '';

                    el.innerHTML = `
                        <div class="relative">
                            <img src="${u.photoURL}" class="w-10 h-10 rounded-full border border-white/50 bg-gray-300 object-cover">
                            ${isOnline ? '<div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border border-white"></div>' : ''}
                        </div>
                        <div class="overflow-hidden flex-1">
                            <div class="text-white text-sm font-bold truncate">${u.displayName}</div>
                            <div class="text-white/60 text-[10px]">${isOnline ? 'Online' : 'Offline'}</div>
                        </div>
                        <!-- Badge Element -->
                        <div id="badge-${u.uid}" class="${badgeHidden} min-w-[20px] h-5 px-1 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center shadow-sm border border-white">${badgeCount}</div>
                    `;
                    usersContainer.appendChild(el);
                });

                if(!foundOthers && !snapshot.empty) {
                     usersContainer.innerHTML = '<div class="text-white/50 text-center text-xs">‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏´‡∏á‡∏≤‡πÜ</div>';
                }
            }, (error) => {
                console.error("Error fetching online users:", error);
            });
        }

        // === CHAT SWITCHING LOGIC ===
        window.switchChat = (partner) => {
            if(messageUnsubscribe) messageUnsubscribe();
            
            chatContainer.innerHTML = ''; 
            currentChatPartner = partner;

            const titleEl = document.getElementById('chatTitle');
            const subEl = document.getElementById('chatSubtitle');
            const avatarEl = document.getElementById('currentChatAvatar');

            if (partner === null) {
                titleEl.innerText = "‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏° (Public)";
                subEl.innerText = "‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô";
                avatarEl.src = "https://cdn-icons-png.flaticon.com/512/166/166258.png"; 
                
                const messagesRef = collection(db, "artifacts", APP_ID, "public", "data", "chat_messages");
                subscribeToMessages(messagesRef);

            } else {
                titleEl.innerText = partner.displayName;
                subEl.innerText = "‡πÅ‡∏ä‡∏ó‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß";
                avatarEl.src = partner.photoURL;

                // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ
                unreadCounts[partner.uid] = 0;
                updateBadgeUI(partner.uid);
                saveUnread();

                const chatId = [currentUser.uid, partner.uid].sort().join('_');
                const messagesRef = collection(db, "artifacts", APP_ID, "public", "data", "private_chats", chatId, "messages");
                subscribeToMessages(messagesRef);
            }
        };

        function subscribeToMessages(collectionRef) {
            const q = query(collectionRef, orderBy("timestamp", "asc"), limit(50));

            messageUnsubscribe = onSnapshot(q, (snapshot) => {
                chatContainer.innerHTML = ''; 
                if (snapshot.empty) {
                    chatContainer.innerHTML = `<div class="text-center py-10 opacity-50 text-white"><p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢...</p></div>`;
                    return;
                }
                
                let lastSenderId = null;
                snapshot.forEach((docSnap) => {
                    const msg = docSnap.data();
                    renderMessage(msg, msg.uid === currentUser.uid, lastSenderId === msg.uid);
                    lastSenderId = msg.uid;
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, (err) => { console.error("Chat error:", err); });
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
        function renderMessage(msg, isMe, isContinuous) {
            const div = document.createElement('div');
            div.className = `flex w-full mb-1 ${isMe ? 'justify-end' : 'justify-start'} msg-anim`;
            
            const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'}) : '...';

            let avatarHtml = '';
            if (!isMe && !isContinuous) {
                avatarHtml = `<img src="${msg.photoURL || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" class="w-8 h-8 rounded-full mr-2 shadow-sm border border-white/30 self-end mb-1 bg-gray-300 object-cover">`;
            } else if (!isMe && isContinuous) {
                avatarHtml = `<div class="w-8 h-8 mr-2"></div>`;
            }

            const bubbleClass = isMe 
                ? 'bg-white text-gray-800 rounded-l-2xl rounded-tr-2xl rounded-br-sm' 
                : 'bg-black/40 backdrop-blur-sm text-white rounded-r-2xl rounded-tl-2xl rounded-bl-sm';

            div.innerHTML = `
                ${avatarHtml}
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[75%]">
                    ${(!isMe && !isContinuous) ? `<span class="text-[10px] text-white/80 ml-1 mb-0.5">${msg.displayName || 'User'}</span>` : ''}
                    <div class="${bubbleClass} px-4 py-2 shadow-md break-words min-w-[2rem] text-left">
                        ${msg.text}
                    </div>
                    <span class="text-[9px] text-white/60 mt-0.5 mx-1">${time}</span>
                </div>
            `;
            chatContainer.appendChild(div);
        }

        // === SEND MESSAGE ===
        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const text = msgInput.value.trim();
            if (!text) return;

            const tempText = text;
            msgInput.value = ''; 

            try {
                let messagesRef;
                if (currentChatPartner === null) {
                    messagesRef = collection(db, "artifacts", APP_ID, "public", "data", "chat_messages"); //part ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡πâ‡∏≠
                } else {
                    const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
                    messagesRef = collection(db, "artifacts", APP_ID, "public", "data", "private_chats", chatId, "messages");
                    
                    // UPDATE ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    const conversationRef = doc(db, "artifacts", APP_ID, "public", "data", "latest_conversations", chatId);
                    await setDoc(conversationRef, {
                        users: [currentUser.uid, currentChatPartner.uid],
                        lastMessage: tempText,
                        senderId: currentUser.uid,
                        timestamp: serverTimestamp()
                    }, { merge: true });
                }

                await addDoc(messagesRef, {
                    text: tempText,
                    uid: currentUser.uid,
                    displayName: currentUser.displayName || "Anonymous",
                    photoURL: currentUser.photoURL || "https://cdn-icons-png.flaticon.com/512/847/847969.png",
                    timestamp: serverTimestamp()
                });
            } catch (err) {
                console.error(err);
                alert("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏õ: " + err.message);
                msgInput.value = tempText;
            }
        };

        // === THEME & UI UTILS ===
        window.toggleUserList = () => {
            const list = document.getElementById('userListSection');
            const overlay = document.getElementById('sidebarOverlay');
            list.classList.toggle('translate-x-full');
            overlay.classList.toggle('hidden');
        };

        const savedTheme = localStorage.getItem('chatTheme') || 'bg-theme-1';
        document.getElementById('mainBody').className = `${savedTheme} h-[100dvh] w-full overflow-hidden text-gray-800 transition-colors duration-500`;

        window.changeTheme = (themeClass) => {
            const body = document.getElementById('mainBody');
            body.classList.forEach(cls => { if(cls.startsWith('bg-theme-')) body.classList.remove(cls); });
            body.classList.add(themeClass);
            localStorage.setItem('chatTheme', themeClass);
        };
    </script>
</body>
</html>
